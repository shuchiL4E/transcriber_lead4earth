<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Transcript Generator</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      max-width: 850px;
      margin: 32px auto;
      padding: 0 16px;
      line-height: 1.5;
      color: #222;
    }
    h1 { font-size: 26px; margin-bottom: 12px; }
    h2 { margin-top: 40px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover:not([disabled]) { background: #0056b3; }
    button[disabled] { opacity: 0.6; cursor: not-allowed; }
    pre {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 12px;
      border-radius: 8px;
      min-height: 120px;
    }
    .muted { color: #666; }
    .section { margin-top: 40px; }
    #status {
      background: #eef7ff;
      border: 1px solid #cce1ff;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      font-size: 15px;
      line-height: 1.4;
      white-space: pre-line;
    }
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 8px;
      overflow: hidden;
      height: 14px;
      margin: 10px 0;
      display: none;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #007bff;
      transition: width 0.3s ease;
    }
    pre {
      white-space: pre-wrap;
      background: #f6f6f6;
      padding: 12px;
      border-radius: 8px;
      min-height: 120px;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <h1>ğŸ§ Transcript Generator</h1>

  <form id="transcriptForm" method="post">
    <div class="row">
      <input type="text" id="url" name="url" placeholder="Paste video/page URL" required />
      <button type="submit" id="generateBtn">Generate</button>
      <button type="button" id="cancelBtn" disabled>Cancel</button>
    </div>
  </form>

  <div id="status" class="muted"></div>
  <div class="progress-container"><div id="progressBar" class="progress-bar"></div></div>

  <h2>Transcript Output</h2>
  <pre id="result">(Transcript will appear here)</pre>

  <div class="section">
    <h2>Check Task Status</h2>
    <div class="row">
      <input type="text" id="taskIdInput" placeholder="Enter Token ID" />
      <button type="button" onclick="checkTaskStatus()">Check Status</button>
    </div>
    <pre id="taskStatusOutput" class="muted"></pre>
  </div>

  <script>
    const form = document.getElementById("transcriptForm");
    const generateBtn = document.getElementById("generateBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const progressBar = document.getElementById("progressBar");
    const progressContainer = document.querySelector(".progress-container");
    let controller = null;

    function setLoading(isLoading, msg = "") {
      generateBtn.disabled = isLoading;
      cancelBtn.disabled = !isLoading;
      if (msg) statusEl.textContent = msg;
      if (!isLoading && statusEl.innerHTML.includes("Whisper fallback")) {
        progressContainer.style.display = "none";
        return;
      }
      progressContainer.style.display = isLoading ? "block" : "none";
    }

    cancelBtn.addEventListener("click", () => {
      if (controller) controller.abort();
      setLoading(false, "âŒ Request canceled.");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultEl.textContent = "";
      progressBar.style.width = "0%";

      const urlVal = document.getElementById("url").value.trim();
      if (!urlVal) {
        statusEl.textContent = "âš ï¸ Please paste a valid URL.";
        return;
      }

      controller = new AbortController();
      const signal = controller.signal;
      const formData = new FormData();
      formData.append("url", urlVal);
      setLoading(true, "ğŸš€ Starting transcription...");

      try {
        const res = await fetch("/transcript", { method: "POST", body: formData, signal });
        const contentType = res.headers.get("content-type") || "";

        if (!res.ok) {
          const maybeText = await res.text();
          throw new Error(`Server error (${res.status}): ${maybeText}`);
        }

        // âœ… handle JSON-only responses (Celery or direct)
        if (contentType.includes("application/json")) {
          const data = await res.json();

          if (data.task_id) {
            statusEl.classList.remove("muted");
            statusEl.innerHTML = data.message ? data.message.replace(/\n/g, "<br>") : `
              ğŸ§  Whisper fallback started.<br/>
              ğŸ“˜ <strong>Task ID:</strong> ${data.task_id}<br/>
              â³ Please copy this ID and check after <strong>15â€“20 minutes</strong> below.
            `;
            const taskInput = document.getElementById("taskIdInput");
            if (taskInput) taskInput.value = data.task_id;
            localStorage.setItem("last_task_id", data.task_id);
            progressContainer.style.display = "none";
            setLoading(false);
            return;
          }

          if (data.transcript) {
            resultEl.textContent = data.transcript;
            statusEl.textContent = "âœ… Completed (direct transcript).";
            setLoading(false);
            return;
          }

          if (data.error) {
            statusEl.textContent = `âŒ ${data.error}`;
            setLoading(false);
            return;
          }
        }

        // âœ… handle stream (Gunicorn/SSE)
        if (!res.body) {
          throw new Error("No response body from server");
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let finalTranscript = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });

          chunk.split("\n").forEach(line => {
            const lower = line.toLowerCase();
            if (!line.trim()) return;
            if (lower.includes("started")) {
              statusEl.textContent = "ğŸš€ Started transcription...";
              progressBar.style.width = "20%";
            } else if (lower.includes("progress")) {
              statusEl.textContent = "ğŸ”„ Processing audio...";
              progressBar.style.width = "60%";
            } else if (lower.includes("completed")) {
              statusEl.textContent = "âœ… Completed!";
              progressBar.style.width = "100%";
            } else {
              finalTranscript += line + "\n";
            }
          });
        }

        resultEl.textContent = finalTranscript || "(No transcript text found)";
        statusEl.textContent = "âœ… Done.";
      } catch (err) {
        statusEl.textContent = `âŒ Error: ${err.message}`;
      } finally {
        setLoading(false);
        controller = null;
      }
    });

    async function checkTaskStatus() {
      const taskId = document.getElementById("taskIdInput").value.trim();
      const outputEl = document.getElementById("taskStatusOutput");
      if (!taskId) {
        outputEl.textContent = "âš ï¸ Please enter a Task ID.";
        return;
      }
      outputEl.textContent = "â³ Checking...";
      try {
        const res = await fetch(`/status/${taskId}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        outputEl.innerHTML = `
          ğŸ“˜ <strong>Status:</strong> ${data.status}<br>
          ğŸ”— <strong>URL:</strong> ${data.url || "N/A"}<br>
          ğŸ•“ <strong>Created:</strong> ${data.created_at || "N/A"}<br>
          ğŸ•“ <strong>Completed:</strong> ${data.completed_at || "Pending"}<br>
          ğŸ§¾ <strong>Transcript:</strong><br><pre>${data.transcript || "(Not yet available)"}</pre>
        `;
      } catch (err) {
        outputEl.textContent = `âŒ ${err.message}`;
      }
    }

    window.addEventListener("load", () => {
      const savedId = localStorage.getItem("last_task_id");
      if (savedId) document.getElementById("taskIdInput").value = savedId;
    });
  </script>
</body>
</html>
